import FilterSection from "@/components/FilterSection";
import JobInfoViewContainer from "@/components/JobInfoViewContainer";
import JobListingItem from "@/components/JobListingItem";
import PaginationBar from "@/components/PaginationBar";
import prisma from "@/lib/db/prisma";
import { Prisma } from "@prisma/client";

type ListingsPageProps = {
  searchParams: {
    keywords: string;
    classification: string;
    location: string;
    page: string;
  };
};

export default async function ListingsPage({
  searchParams: { classification, keywords, location, page = "1" },
}: ListingsPageProps) {
  const orConditions = [];
  if (keywords) {
    orConditions.push({
      title: {
        contains: keywords,
        mode: Prisma.QueryMode.insensitive,
      },
    });
  }

  if (classification) {
    orConditions.push({
      industry: {
        contains: classification,
        mode: Prisma.QueryMode.insensitive,
      },
    });
  }

  if (location) {
    orConditions.push({
      location: {
        contains: location,
        mode: Prisma.QueryMode.insensitive,
      },
    });
  }

  const currentPage = parseInt(page);
  const pageSize = 5;
  const totalItemCount =
    orConditions.length > 0
      ? await prisma.job.count({ where: { OR: orConditions } })
      : await prisma.job.count();
  const totalPages = Math.ceil(totalItemCount / pageSize);

  const jobs =
    orConditions.length > 0
      ? await prisma.job.findMany({
          where: { OR: orConditions },
          include: { company: true },
          skip: (currentPage - 1) * pageSize,
          take: pageSize,
        })
      : await prisma.job.findMany({
          include: { company: true },
          skip: (currentPage - 1) * pageSize,
          take: pageSize,
        });

  return (
    <main className="">
      <FilterSection
        classification={classification}
        keywords={keywords}
        location={location}
      />
      <div className="p-4 max-w-7xl mx-auto flex flex-col gap-12 lg:flex-row justify-between lg:px-24">
        <div className="flex flex-col gap-8 flex-1">
          {jobs.length === 0 && (
            <div className="card w-full lg:w-96 gap-3 items-center text-center justify-center flex">
              <svg
                width="108"
                height="96"
                viewBox="0 0 108 96"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                role="img"
              >
                <path
                  d="M13.8437 26.9075C13.5896 27.1362 13.5742 27.5219 13.8093 27.7689C18.1055 32.282 15.8152 37.1263 15.7161 37.3292C15.5662 37.6325 15.6976 37.9967 16.0098 38.1426C16.0972 38.1836 16.1898 38.2028 16.2809 38.2028C16.5144 38.2028 16.7386 38.0754 16.8465 37.8571C16.8748 37.8 19.6181 32.076 14.7297 26.9409C14.4943 26.6935 14.0976 26.6784 13.8437 26.9075Z"
                  fill="#C17742"
                ></path>
                <path
                  d="M104.198 22.5065C103.799 22.5065 103.42 22.5847 103.074 22.725C102.33 19.317 99.219 16.7597 95.4919 16.7597C91.2106 16.7597 87.7397 20.134 87.7397 24.2966C87.7397 24.6522 87.767 25.0015 87.8159 25.344H107.116C107.116 23.7769 105.809 22.5065 104.198 22.5065Z"
                  fill="#88E2E9"
                ></path>
                <path
                  d="M43.0183 30.2682C43.0183 33.3522 42.2885 35.5555 40.2268 37.0839C39.0219 37.9771 37.4319 37.143 36.9757 36.4544C36.5668 35.8001 36.342 35.0233 36.4609 34.3482C36.5328 33.9406 36.7218 33.0827 36.9018 32.2895C37.1297 31.2849 37.1219 29.8795 36.6617 28.8697C36.554 28.8703 36.4448 28.871 36.3375 28.8716C34.0533 28.8846 31.8833 28.8947 30.0317 28.8914L30.065 37.8561L30.0657 38.0643L27.7542 38.0724C24.8534 38.0826 22.3735 40.2976 22.3311 43.1174C22.3066 44.7493 23.0676 46.2066 24.2679 47.1604C25.1805 47.8857 26.3465 48.3206 27.6172 48.3161L30.1034 48.3073L30.1363 57.2187L39.4389 57.1862V57.1815H39.9326V54.9125C39.9326 52.1131 42.2427 49.8401 45.1104 49.7932C47.8189 49.9968 49.9564 52.1929 49.9663 54.8805L49.9747 57.1496L50.4683 57.1478V57.1816H59.7711V48.2701H62.2571C65.1993 48.2701 67.5781 45.9256 67.5242 43.0529C67.4713 40.2334 64.9832 38.0269 62.0825 38.0269H59.7711V28.854H50.6766C48.4378 28.825 45.7218 28.8256 42.896 28.8365C42.8733 28.8366 42.8503 28.8367 42.8276 28.8368C42.9456 29.3145 43.0183 29.7941 43.0183 30.2682Z"
                  fill="#EE399E"
                ></path>
                <path
                  d="M42.8278 28.8366C42.8505 28.8365 42.8735 28.8364 42.8962 28.8363C42.2342 25.7703 39.5936 22.7324 38.6995 22.0967C37.0419 20.916 34.6056 20.4077 30.9921 20.6155C30.8233 20.6253 30.6231 20.6469 30.4002 20.6779C30.5854 20.0813 30.8359 19.3421 31.0724 18.8672C32.385 16.2323 32.6786 16.0142 34.4886 13.8578C36.6723 11.2561 40.977 9.40841 42.1511 7.43127C43.9265 4.44159 39.9627 1.66677 36.5429 3.4667C34.5992 4.48945 30.5767 7.44068 28.3831 10.1241C26.1893 12.8081 24.498 15.3707 23.861 16.5358C23.6076 16.9991 22.9012 18.0812 22.9012 18.0812C22.9012 18.0812 23.0186 17.0053 23.1208 16.3939C23.3255 15.1725 24.5714 12.619 26.0109 10.509C27.494 8.33482 29.7922 6.61951 30.9672 4.64084C33.002 1.21449 28.9877 -1.5502 25.8648 0.98692C23.9096 2.57515 21.4396 5.26705 19.7249 7.71612C17.5378 10.8397 16.2623 13.9629 15.9082 14.6254C15.7947 14.8381 15.4208 16.2883 15.2833 16.2572C15.1461 16.2255 14.9284 14.8729 15.1956 13.7154C15.6676 11.67 15.3269 12.7484 16.3539 10.2783C17.121 8.43291 18.3721 7.18289 18.5258 6.26696C19.158 2.50152 15.2072 1.3796 13.0435 3.92519C12.7378 4.28494 11.6351 5.76671 10.0867 9.29417C8.53812 12.8222 7.83919 15.627 7.33967 17.4075C5.65809 23.4015 4.59442 28.4411 4.49039 29.9074C4.30104 32.5775 4.55515 34.8057 5.4574 36.6636L0.311192 45.3295C0.310893 45.33 0.310889 45.33 0.310567 45.3305L0.28303 45.3769L0.285733 45.3784C-0.987822 47.6634 2.1129 51.8159 7.25837 54.6925C12.3791 57.5544 17.6035 58.079 19.0245 55.8967L19.0291 55.8993L24.2163 47.1643C24.2334 47.1635 24.2509 47.1612 24.2681 47.1602C23.0678 46.2064 22.3068 44.7491 22.3313 43.1172C22.3737 40.2974 24.8536 38.0824 27.7544 38.0722L30.0659 38.0641L30.0652 37.8559C29.7505 37.7846 29.4435 37.6696 29.1593 37.4984C28.2152 36.9292 27.1612 36.1266 26.8165 35.2312C25.8372 32.6874 26.9838 29.9861 28.1019 28.8045C29.5282 27.2968 30.7571 26.3354 33.5373 26.8058C34.6407 26.9921 35.525 27.8191 36.191 28.6638C36.2439 28.7309 36.2893 28.8019 36.3377 28.8714C36.445 28.8708 36.5542 28.8702 36.6619 28.8695C37.122 29.8793 37.1299 31.2847 36.902 32.2893C36.722 33.0825 36.533 33.9404 36.4611 34.348C36.3422 35.0231 36.567 35.7999 36.9759 36.4542C37.4321 37.1428 39.0221 37.9769 40.227 37.0837C42.2887 35.5554 43.0185 33.352 43.0185 30.268C43.0185 29.7939 42.9458 29.3143 42.8278 28.8366ZM16.8467 37.8571C16.7388 38.0754 16.5146 38.2028 16.2812 38.2028C16.1901 38.2028 16.0975 38.1836 16.01 38.1426C15.6979 37.9967 15.5665 37.6325 15.7164 37.3292C15.8154 37.1263 18.1057 32.2819 13.8096 27.7689C13.5745 27.5218 13.5898 27.1362 13.8439 26.9075C14.0979 26.6784 14.4945 26.6935 14.73 26.9409C19.6183 32.076 16.875 37.7999 16.8467 37.8571Z"
                  fill="#EBAB7D"
                ></path>
                <path
                  d="M95.4871 40.8087H73.1593V49.8527H70.2335C66.2133 49.8419 64.0223 54.4684 66.8089 57.2698C67.6682 58.1431 68.8258 58.6239 70.0683 58.6239H73.1593V67.6679H80.948V66.1643C80.9171 62.6763 83.9444 59.8976 87.3835 60.1541C89.888 60.292 92.1714 62.103 92.7862 64.4702C93.0851 65.3567 92.9797 66.7407 92.9976 67.6679H100.786V45.9606C100.786 43.1198 98.4091 40.8087 95.4871 40.8087Z"
                  fill="#F470BD"
                ></path>
                <path
                  d="M91.3254 64.8545C90.933 63.3628 89.6534 62.1361 88.1221 61.752C86.9788 61.4587 85.718 61.629 84.7101 62.233C83.6172 62.8842 82.8101 63.9884 82.551 65.2697C82.3889 65.88 82.4872 68.4754 82.4621 69.1404H73.1636V76.771H74.714C77.5367 76.646 80.2167 78.6888 80.7684 81.3704C81.6387 84.9221 78.6573 88.5607 74.8888 88.4861C74.7927 88.4966 73.2951 88.4787 73.1636 88.4862V96H92.2706C97.0458 96 100.786 92.3632 100.786 87.7208V69.1404H91.4836C91.4431 68.2768 91.6064 65.6477 91.3254 64.8545Z"
                  fill="#F470BD"
                ></path>
                <path
                  d="M79.3941 82.688C79.446 80.2752 77.3055 78.2365 74.7139 78.2427H71.6493V69.1401H63.9931V70.8213C64.0655 74.0711 61.0357 76.8861 57.697 76.6729C54.4708 76.535 51.9433 73.8943 51.9433 70.6607V69.1401H44.0225V80.0506C45.3193 81.7147 46.1463 83.7442 46.3063 85.9537C46.4257 85.9438 46.5457 85.9359 46.6676 85.9359C49.0396 85.9359 50.9626 87.8055 50.9626 90.1118H44.0225V90.7267C44.0225 92.12 44.5851 93.4252 45.6067 94.4017C46.6273 95.3774 47.9769 95.9186 49.4091 95.878C55.9413 95.7806 65.5861 95.6462 71.6493 95.9524V87.014H74.7233C77.2446 87.0179 79.3809 85.0448 79.3941 82.688Z"
                  fill="#F470BD"
                ></path>
                <path
                  d="M50.9625 90.1114C50.9625 87.8051 49.0394 85.9354 46.6675 85.9354C46.5455 85.9354 46.4255 85.9434 46.3062 85.9532C46.1462 83.7438 45.3192 81.7143 44.0223 80.0502C41.94 77.3783 38.6435 75.6508 34.9293 75.6508C29.8065 75.6508 25.4725 78.9336 24.0308 83.4531C23.4388 83.2582 22.8069 83.1476 22.1472 83.1476C18.9025 83.1476 16.2725 85.7048 16.2725 88.8594C16.2725 89.29 16.3254 89.7079 16.4182 90.1114H50.9625Z"
                  fill="#88E2E9"
                ></path>
              </svg>
              <p className="text-2xl">No matching search results.</p>
              <p className="text-sm">
                We couldnâ€™t find anything that matched your search.
              </p>
              <p className="text-sm">Try checking for spelling errors.</p>
            </div>
          )}
          {jobs.map((job) => (
            <JobListingItem key={job.id} job={job} page={currentPage} />
          ))}
        </div>

        <JobInfoViewContainer />
      </div>
      <div className="max-w-7xl w-full mx-auto flex justify-center">
        {totalPages > 1 && (
          <PaginationBar
            currentPage={currentPage}
            totalPages={totalPages}
            classification={classification}
            keywords={keywords}
            location={location}
          />
        )}
      </div>
    </main>
  );
}
